#!/bin/bash

set -eu
# shellcheck source=tests/scripts/config.source
. "$(dirname "$(dirname "$(realpath "$0")")")"/config.source

cleanup() {
  pulp python repository destroy --name python || true
  pulp python remote destroy --name python || true
  pulp file repository destroy --name file-repo || true
}
trap cleanup EXIT

pulp debug has-plugin --name "core" --specifier ">=3.85.3" || exit 0
pulp debug has-plugin --name "python" --specifier ">=3.21.0" || exit 0

# create a test repository
pulp python repository create --name python
pulp python remote create --name python --url "https://pypi.org/" --includes '["django==5.2.1"]'
pulp python repository sync --name python --remote python

expect_succ pulp python repository version scan --repository python
VULN_REPORT=$(echo "$OUTPUT" | jq .pulp_href -r)
expect_succ pulp vulnerability-report show --href "$VULN_REPORT"

#  test with non-implemented content type
pulp file repository create --name file-repo
expect_fail pulp file repository version scan --repository file-repo
